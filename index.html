<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>His Master‚Äôs Open Voices ‚Äì Kor-radio (Compact)</title>

  <style>
    :root{
      --bg:#f3efe7;
      --wood1:#8a5632;
      --wood2:#6f4022;
      --wood3:#5a3118;

      --frame:#f1eef2;
      --frame2:#ded8dc;

      --glass1:#e7e1d6;
      --glass2:#cfc6b6;

      --speaker1:#d8c49b;
      --speaker2:#c9b07c;

      --ink:#1a1410;
      --muted:#6a5a4c;

      --accent:#9c1b1b;
      --shadow: 0 20px 50px rgba(0,0,0,.22);

      --r: 22px;
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 30% 0%, #fff, transparent 60%),
                  linear-gradient(180deg, #fbf7ef, var(--bg));
      color: var(--ink);
      padding: 12px;
      display:flex;
      justify-content:center;
    }

    /* Mobile-first: radio first, playlist under */
    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items:start;
    }

    @media (min-width: 980px){
      body{ padding: 22px; }
      .wrap{
        grid-template-columns: 1.25fr .75fr;
        gap: 18px;
      }
    }

    /* ===== RADIO CABINET ===== */
    .cabinet{
      border-radius: 28px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.18), transparent 45%),
        linear-gradient(135deg, var(--wood1), var(--wood2) 55%, var(--wood3));
      border: 1px solid rgba(0,0,0,.25);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      padding: 10px;
    }

    .cabinet::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(90deg,
          rgba(0,0,0,.05) 0 2px,
          rgba(255,255,255,.02) 2px 6px,
          rgba(0,0,0,.03) 6px 11px);
      opacity:.35;
      mix-blend-mode:multiply;
      pointer-events:none;
    }

    .radioInner{
      position:relative;
      z-index:1;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.04));
      border: 1px solid rgba(255,255,255,.18);
      padding: 10px;
    }

    .topBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
      user-select:none;
    }
    .brandPill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(0,0,0,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
      min-width:0;
      flex: 1 1 auto;
    }
    .badge{
      width: 32px; height: 32px;
      border-radius: 10px;
      background: linear-gradient(180deg, var(--frame), var(--frame2));
      border: 1px solid rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      font-weight: 900;
      color: rgba(0,0,0,.62);
      letter-spacing:.08em;
      text-shadow: 0 1px 0 rgba(255,255,255,.55);
      flex:0 0 auto;
    }
    .brandTxt{ min-width:0; }
    .brandTxt b{
      display:block;
      font-size: 12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: rgba(255,255,255,.88);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brandTxt span{
      display:block;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .powerBtn{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.20);
      background: linear-gradient(180deg, var(--frame), var(--frame2));
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      color: rgba(0,0,0,.68);
      flex: 0 0 auto;
      white-space:nowrap;
    }
    .powerDot{
      width: 10px; height: 10px; border-radius:999px;
      background: rgba(0,0,0,.25);
      box-shadow: inset 0 2px 6px rgba(0,0,0,.25);
    }
    .powerOn .powerDot{
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(156,27,27,.15), 0 8px 18px rgba(156,27,27,.28);
    }

    /* ===== COMPACT WINDOWS =====
       Mobile-first: always side-by-side if possible, otherwise stacked.
       We use small aspect ratios so they don't get too tall. */
    .windows{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 420px){
      .windows{ grid-template-columns: 1fr; }
    }

    .windowFrame{
      border-radius: 18px;
      background: linear-gradient(180deg, var(--frame), var(--frame2));
      border: 1px solid rgba(0,0,0,.20);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.45);
      padding: 8px;
      overflow:hidden;
    }
    .windowInset{
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.18);
      box-shadow: inset 0 10px 22px rgba(0,0,0,.10);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.35), rgba(0,0,0,.06));
    }

    .speaker{
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.16), transparent 45%),
        repeating-linear-gradient(0deg, rgba(0,0,0,.12) 0 1px, rgba(255,255,255,.05) 1px 6px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.08) 0 1px, rgba(255,255,255,.03) 1px 7px),
        linear-gradient(180deg, var(--speaker1), var(--speaker2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px;
      aspect-ratio: 16 / 10;
      min-height: 120px;
    }

    .logoPlate{
      width: 94%;
      border-radius: 12px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(0,0,0,.18);
      padding: 8px 10px;
      text-align:center;
    }
    .logoText{
      font-family: "Georgia", "Times New Roman", serif;
      text-transform:uppercase;
      letter-spacing:.14em;
      font-weight: 800;
      font-size: 12px;
      color: rgba(0,0,0,.65);
      line-height:1.15;
    }
    .logoSub{
      margin-top: 6px;
      font-family: "Georgia", "Times New Roman", serif;
      letter-spacing:.12em;
      font-size: 10px;
      color: rgba(0,0,0,.55);
    }

    .tuner{
      background:
        radial-gradient(circle at 15% 15%, rgba(255,255,255,.35), transparent 55%),
        linear-gradient(180deg, var(--glass1), var(--glass2));
      padding: 10px;
      aspect-ratio: 16 / 10;
      min-height: 120px;
      user-select:none;
    }

    .tunerTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      font-family: "Georgia", "Times New Roman", serif;
      font-size: 10px;
      letter-spacing:.10em;
      color: rgba(0,0,0,.58);
      text-transform:uppercase;
    }
    .tunerMid{
      margin-top: 8px;
      border-radius: 12px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(0,0,0,.18);
      padding: 8px;
      position:relative;
      overflow:hidden;
    }
    .scale{
      display:flex;
      justify-content:space-between;
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.08em;
      color: rgba(0,0,0,.62);
    }
    .ticks{
      margin-top: 6px;
      height: 14px;
      background: repeating-linear-gradient(90deg, rgba(0,0,0,.55) 0 1px, transparent 1px 8px);
      opacity:.55;
      border-radius: 6px;
    }
    .needle{
      position:absolute;
      top: 6px;
      bottom: 6px;
      width: 2px;
      left: 10px;
      background: var(--accent);
      box-shadow: 0 0 0 1px rgba(255,255,255,.55);
      border-radius: 2px;
      pointer-events:none;
    }
    .tunerBottom{ display:none; } /* compact: hidden */

    /* ===== CONTROLS (compact) ===== */
    .controlRow{
      margin-top: 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .now{
      flex: 1 1 240px;
      min-width: 0;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(0,0,0,.18);
      color: rgba(255,255,255,.88);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.20);
    }
    .now b{
      display:block;
      font-size: 13px;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .now small{
      display:block;
      margin-top:4px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .status{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,.68);
      line-height:1.25;
    }

    .buttons{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1 1 auto;
    }

    .btn{
      border: 1px solid rgba(0,0,0,.22);
      background: linear-gradient(180deg, var(--frame), var(--frame2));
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
      color: rgba(0,0,0,.70);
      font-weight: 900;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btnRound{
      width: 48px; height: 48px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-size: 16px;
    }
    .btnPlay{
      padding: 12px 14px;
      border-radius: 999px;
      border: 2px solid rgba(156,27,27,.32);
      font-size: 14px;
      white-space:nowrap;
    }
    .toggleOn{ outline: 3px solid rgba(156,27,27,.14); }

    /* progress: hide on very low height embeds */
    .progressWrap{ margin-top: 10px; }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(0,0,0,.18);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(156,27,27,.75), rgba(156,27,27,.20));
    }
    .timeRow{
      margin-top: 6px;
      display:flex;
      justify-content:space-between;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      user-select:none;
    }

    /* If embed height is small, auto-hide progress to avoid scrollbars */
    @media (max-height: 720px){
      .progressWrap{ display:none; }
    }

    .bottomRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
      color: rgba(255,255,255,.72);
      font-size: 12px;
    }

    .volPill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(0,0,0,.18);
      user-select:none;
    }
    input[type="range"]{ width: 170px; }

    .link{
      color: rgba(255,255,255,.78);
      text-decoration:none;
      border-bottom: 1px dashed rgba(255,255,255,.35);
    }

    /* knobs strip hidden in compact mode */
    .knobStrip{ display:none; }

    /* ===== PLAYLIST: foldable ===== */
    .book{
      border-radius: 18px;
      background: linear-gradient(180deg, #fffaf0, #f2eadc);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 16px 38px rgba(0,0,0,.12);
      padding: 14px;
    }

    summary{
      cursor:pointer;
      user-select:none;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size: 14px;
      color: rgba(0,0,0,.65);
      padding: 6px 2px;
    }
    summary::-webkit-details-marker{ display:none; }
    .chev{
      width: 34px; height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.65);
      font-weight: 900;
      color: rgba(0,0,0,.55);
      flex: 0 0 auto;
    }

    .list{
      margin: 10px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:8px;
      max-height: none;
      overflow: visible;
    }

    @media (min-width: 980px){
      .list{
        max-height: 560px;
        overflow:auto;
        padding-right: 6px;
      }
    }

    .item{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.65);
      cursor:pointer;
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(0,0,0,.22);
      flex:0 0 auto;
    }
    .item.active{
      background: rgba(156,27,27,.10);
      border-color: rgba(156,27,27,.22);
    }
    .item.active .dot{
      background: var(--accent);
      box-shadow: 0 6px 14px rgba(156,27,27,.22);
    }
    .itemTitle{
      font-weight: 900;
      font-size: 13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .itemSub{
      font-size: 12px;
      color: rgba(0,0,0,.55);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .note{
      margin-top:10px;
      font-size:12px;
      color: rgba(0,0,0,.55);
      line-height:1.35;
    }

    /* Off dim */
    .off .radioInner{ filter: saturate(.7) contrast(.95); }
    .off .now, .off .status, .off .bottomRow{ opacity:.65; }
    .off .needle{ opacity:.45; }
    .off .btn{ filter: grayscale(.25); }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- RADIO -->
    <div class="cabinet off" id="cabinet">
      <div class="radioInner">

        <div class="topBar">
          <div class="brandPill">
            <div class="badge">FM</div>
            <div class="brandTxt">
              <b>Kor-radio</b>
              <span>His Master‚Äôs Open Voices</span>
            </div>
          </div>

          <button class="powerBtn" id="btnPower" type="button" aria-pressed="false" title="T√¶nd / sluk">
            <span class="powerDot"></span>
            <span id="powerLabel">OFF</span>
          </button>
        </div>

        <div class="windows">
          <!-- LEFT -->
          <div class="windowFrame">
            <div class="windowInset speaker" aria-label="H√∏jttaler og logo">
              <div class="logoPlate">
                <div class="logoText">HIS MASTER‚ÄôS<br/>OPEN VOICES</div>
                <div class="logoSub">√Öbne Stemmer ‚Ä¢ Aller√∏d</div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="windowFrame">
            <div class="windowInset tuner" aria-label="Tuner">
              <div class="tunerTop">
                <span>Skala</span>
                <span id="freqReadout">96.0 MHz</span>
              </div>

              <div class="tunerMid">
                <div class="scale">
                  <span>88</span><span>92</span><span>96</span><span>100</span><span>104</span><span>108</span>
                </div>
                <div class="ticks"></div>
                <div class="needle" id="dialNeedle"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="controlRow">
          <div class="now">
            <b id="nowName">Slukket</b>
            <small id="nowMeta">Tryk ON for at t√¶nde</small>
            <div class="status" id="statusHint">Tip: Shuffle giver ‚Äúradio-feeling‚Äù.</div>
          </div>

          <div class="buttons">
            <button class="btn btnRound" id="btnPrev" type="button" title="Forrige">‚üµ</button>
            <button class="btn btnPlay" id="btnPlay" type="button" title="Afspil / Pause">‚ñ∂ Start</button>
            <button class="btn btnRound" id="btnNext" type="button" title="N√¶ste">‚ü∂</button>
            <button class="btn btnRound" id="btnShuffle" type="button" title="Shuffle">üîÄ</button>
            <button class="btn btnRound toggleOn" id="btnLoop" type="button" title="Loop">üîÅ</button>
          </div>
        </div>

        <div class="progressWrap">
          <div class="bar" id="bar"><div id="barFill"></div></div>
          <div class="timeRow"><span id="tCur">0:00</span><span id="tDur">0:00</span></div>
        </div>

        <div class="bottomRow">
          <div class="volPill">
            VOL
            <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85" />
          </div>
          <div>
            <span id="count">0</span> numre ‚Ä¢ <a class="link" href="#" id="openTrack">√Öbn fil</a>
          </div>
        </div>

        <audio id="audio" preload="metadata"></audio>
      </div>
    </div>

    <!-- PLAYLIST (foldable) -->
    <div class="book">
      <details id="plDetails">
        <summary>
          Playlist
          <span class="chev" id="chev">‚åÑ</span>
        </summary>
        <ul class="list" id="list"></ul>
        <div class="note">
          Mobil-tip: Tryk ON ‚Üí v√¶lg sang ‚Üí ‚ñ∂ Start. Autoplay med lyd kr√¶ver normalt et klik.
        </div>
      </details>
    </div>

  </div>

<script>
  const TRACKS = [
    { title: "1. 21-4",                         artist: "√Öbne Stemmer", url: "01-21-4.mp3" },
    { title: "2. Weather With You",             artist: "√Öbne Stemmer", url: "02-weather-with-you.mp3" },
    { title: "3. Fragile",                      artist: "√Öbne Stemmer", url: "03-fragile.mp3" },
    { title: "4. Ordinary World",               artist: "√Öbne Stemmer", url: "04-Ordinary-World.mp3" },
    { title: "5. Det kun vigtigt (hvad det er)",artist: "√Öbne Stemmer", url: "05-det-kun-vigtigt-hvad-det-er.mp3" },
    { title: "6. Frit Land",                    artist: "√Öbne Stemmer", url: "06-frit-land.mp3" },
    { title: "7. I morgen er der osse en dag",  artist: "√Öbne Stemmer", url: "07-imorgen-er-der-osse-en-dag.mp3" },
    { title: "8. Africa",                       artist: "√Öbne Stemmer", url: "08-africa.mp3" },
    { title: "9. Afterglow",                    artist: "√Öbne Stemmer", url: "09-afterglow.mp3" }
  ];

  const el = (id)=>document.getElementById(id);

  const cabinet = el("cabinet");
  const btnPower = el("btnPower");
  const powerLabel = el("powerLabel");

  const audio = el("audio");
  const listEl = el("list");
  const nowName = el("nowName");
  const nowMeta = el("nowMeta");
  const statusHint = el("statusHint");
  const btnPlay = el("btnPlay");
  const btnNext = el("btnNext");
  const btnPrev = el("btnPrev");
  const btnShuffle = el("btnShuffle");
  const btnLoop = el("btnLoop");
  const bar = el("bar");
  const barFill = el("barFill");
  const tCur = el("tCur");
  const tDur = el("tDur");
  const vol = el("vol");
  const count = el("count");
  const openTrack = el("openTrack");
  const dialNeedle = el("dialNeedle");
  const freqReadout = el("freqReadout");

  const plDetails = el("plDetails");
  const chev = el("chev");

  let index = 0;
  let isShuffle = false;
  let isLoop = true;
  let isOn = false;

  // Collapse playlist on mobile by default
  if (window.matchMedia && window.matchMedia("(max-width: 979px)").matches){
    plDetails.open = false;
    chev.textContent = "‚åÑ";
  } else {
    plDetails.open = true;
    chev.textContent = "‚åÉ";
  }
  plDetails.addEventListener("toggle", ()=>{
    chev.textContent = plDetails.open ? "‚åÉ" : "‚åÑ";
  });

  function fmt(sec){
    if (!isFinite(sec) || sec < 0) return "0:00";
    sec = Math.floor(sec);
    const m = Math.floor(sec/60);
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  function renderList(){
    listEl.innerHTML = "";
    TRACKS.forEach((t,i)=>{
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <span class="dot" aria-hidden="true"></span>
        <div style="min-width:0;">
          <div class="itemTitle">${t.title}</div>
          <div class="itemSub">${t.artist || ""}</div>
        </div>
      `;
      li.addEventListener("click", ()=> load(i, true));
      listEl.appendChild(li);
    });
    count.textContent = TRACKS.length;
  }

  function setActive(){
    [...listEl.children].forEach((li,i)=> li.classList.toggle("active", i===index));
  }

  function moveNeedle(){
    const pct = (index / Math.max(1, TRACKS.length - 1));
    dialNeedle.style.left = `calc(10px + ${pct} * (100% - 20px))`;
    const freq = 88 + pct * 20;
    freqReadout.textContent = `${freq.toFixed(1)} MHz`;
  }

  function load(i, autoplay=false){
    index = (i + TRACKS.length) % TRACKS.length;
    setActive();
    moveNeedle();

    const t = TRACKS[index];
    openTrack.href = t.url;

    if (!isOn){
      nowName.textContent = t.title;
      nowMeta.textContent = "Klar n√•r du t√¶nder";
      statusHint.textContent = "Radioen er slukket. Tryk ON f√∏rst.";
      return;
    }

    audio.src = t.url;
    nowName.textContent = t.title;
    nowMeta.textContent = t.artist || "";

    if (autoplay){
      audio.play().then(()=>{
        btnPlay.textContent = "‚è∏ Pause";
        statusHint.textContent = isShuffle ? "Shuffle t√¶ndt ‚Äî radio-feeling!" : "Afspiller i r√¶kkef√∏lge.";
      }).catch(()=>{
        statusHint.textContent = "Klik ‚ñ∂ Start for at afspille (browser kr√¶ver et klik).";
      });
    } else {
      btnPlay.textContent = "‚ñ∂ Start";
      statusHint.textContent = "Tryk ‚ñ∂ Start (autoplay kr√¶ver normalt et klik).";
    }
  }

  function next(){
    if (!isOn) return;
    if (isShuffle && TRACKS.length > 1){
      let n = index;
      while (n === index) n = Math.floor(Math.random()*TRACKS.length);
      load(n, true);
    } else {
      load(index + 1, true);
    }
  }
  function prev(){ if (isOn) load(index - 1, true); }

  // ===== Longer retro power hiss/crackle =====
  let AC = null;
  function ensureAudioContext(){
    if (!AC) AC = new (window.AudioContext || window.webkitAudioContext)();
    return AC;
  }

  function playPowerSound({on=true}){
    const ac = ensureAudioContext();
    const now = ac.currentTime;

    const master = ac.createGain();
    master.gain.setValueAtTime(0.0001, now);
    master.connect(ac.destination);

    const dur = on ? 0.75 : 0.45;

    // noise buffer
    const bufferSize = Math.floor(ac.sampleRate * dur);
    const buffer = ac.createBuffer(1, bufferSize, ac.sampleRate);
    const data = buffer.getChannelData(0);

    for (let i=0; i<bufferSize; i++){
      const t = i / bufferSize;
      let s = (Math.random()*2 - 1) * 0.26;  // base hiss
      const p = on ? 0.014 : 0.008;          // more crackle on ON
      if (Math.random() < p){
        s += (Math.random()*2 - 1) * (on ? 1.35 : 1.0) * (1 - t);
      }
      const env = (t < 0.10) ? (t/0.10) : Math.pow(1 - t, 1.05);
      data[i] = s * env;
    }

    const noise = ac.createBufferSource();
    noise.buffer = buffer;

    const bp = ac.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.setValueAtTime(on ? 1200 : 900, now);
    bp.Q.setValueAtTime(0.95, now);

    const lp = ac.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.setValueAtTime(on ? 5200 : 4200, now);

    const nGain = ac.createGain();
    nGain.gain.setValueAtTime(0.0001, now);
    nGain.gain.linearRampToValueAtTime(on ? 0.16 : 0.11, now + 0.03);
    nGain.gain.exponentialRampToValueAtTime(0.0001, now + dur);

    // click transient
    const click = ac.createOscillator();
    click.type = "square";
    click.frequency.setValueAtTime(on ? 240 : 180, now);

    const cGain = ac.createGain();
    cGain.gain.setValueAtTime(0.0, now);
    cGain.gain.linearRampToValueAtTime(on ? 0.18 : 0.13, now + 0.004);
    cGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.055);

    noise.connect(bp);
    bp.connect(nGain);
    nGain.connect(lp);
    lp.connect(master);

    click.connect(cGain);
    cGain.connect(master);

    master.gain.exponentialRampToValueAtTime(1.0, now + 0.01);
    master.gain.exponentialRampToValueAtTime(0.0001, now + dur + 0.03);

    noise.start(now);
    noise.stop(now + dur);

    click.start(now);
    click.stop(now + 0.06);
  }

  function setPower(state){
    isOn = state;

    cabinet.classList.toggle("off", !isOn);
    btnPower.classList.toggle("powerOn", isOn);
    btnPower.setAttribute("aria-pressed", isOn ? "true" : "false");
    powerLabel.textContent = isOn ? "ON" : "OFF";

    if (isOn){
      playPowerSound({on:true});
      const t = TRACKS[index];
      nowName.textContent = t?.title || "Klar";
      nowMeta.textContent = "V√¶lg sang i playlisten";
      statusHint.textContent = "Tryk ‚ñ∂ Start (autoplay kr√¶ver normalt et klik).";
      openTrack.href = t?.url || "#";
      moveNeedle();
    } else {
      playPowerSound({on:false});
      audio.pause();
      audio.currentTime = 0;
      btnPlay.textContent = "‚ñ∂ Start";
      nowName.textContent = "Slukket";
      nowMeta.textContent = "Tryk ON for at t√¶nde";
      statusHint.textContent = "Tip: Shuffle giver ‚Äúradio-feeling‚Äù.";
      barFill.style.width = "0%";
      tCur.textContent = "0:00";
      tDur.textContent = "0:00";
    }
  }

  btnPower.addEventListener("click", ()=>{
    ensureAudioContext();
    setPower(!isOn);
  });

  btnPlay.addEventListener("click", ()=>{
    if (!isOn){
      statusHint.textContent = "Radioen er slukket. Tryk ON f√∏rst.";
      return;
    }
    if (!audio.src){
      const t = TRACKS[index];
      audio.src = t.url;
      openTrack.href = t.url;
    }

    if (audio.paused){
      audio.play().then(()=>{
        btnPlay.textContent = "‚è∏ Pause";
        statusHint.textContent = isShuffle ? "Shuffle t√¶ndt ‚Äî radio-feeling!" : "Afspiller i r√¶kkef√∏lge.";
      }).catch(()=>{
        statusHint.textContent = "Kunne ikke starte. Tjek at mp3-filer kan √•bnes direkte.";
      });
    } else {
      audio.pause();
      btnPlay.textContent = "‚ñ∂ Start";
      statusHint.textContent = "Sat p√• pause.";
    }
  });

  btnNext.addEventListener("click", next);
  btnPrev.addEventListener("click", prev);

  btnShuffle.addEventListener("click", ()=>{
    if (!isOn){
      statusHint.textContent = "Radioen er slukket. Tryk ON f√∏rst.";
      return;
    }
    isShuffle = !isShuffle;
    btnShuffle.classList.toggle("toggleOn", isShuffle);
    statusHint.textContent = isShuffle ? "Shuffle t√¶ndt ‚Äî radio-feeling!" : "Shuffle slukket ‚Äî afspiller i r√¶kkef√∏lge.";
  });

  btnLoop.addEventListener("click", ()=>{
    if (!isOn){
      statusHint.textContent = "Radioen er slukket. Tryk ON f√∏rst.";
      return;
    }
    isLoop = !isLoop;
    btnLoop.classList.toggle("toggleOn", isLoop);
    statusHint.textContent = isLoop ? "Loop t√¶ndt ‚Äî spiller videre." : "Loop slukket ‚Äî stopper efter sidste nummer.";
  });

  audio.addEventListener("timeupdate", ()=>{
    const p = (audio.currentTime / (audio.duration || 1)) * 100;
    barFill.style.width = `${Math.min(100, Math.max(0,p))}%`;
    tCur.textContent = fmt(audio.currentTime);
    tDur.textContent = fmt(audio.duration);
  });

  audio.addEventListener("ended", ()=>{
    if (!isOn) return;
    if (index === TRACKS.length - 1 && !isLoop && !isShuffle){
      btnPlay.textContent = "‚ñ∂ Start";
      statusHint.textContent = "F√¶rdig (loop er slukket).";
      return;
    }
    next();
  });

  bar.addEventListener("click", (e)=>{
    if (!isOn) return;
    const r = bar.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width;
    if (audio.duration) audio.currentTime = x * audio.duration;
  });

  vol.addEventListener("input", ()=> audio.volume = parseFloat(vol.value));
  audio.volume = parseFloat(vol.value);

  openTrack.addEventListener("click", (e)=>{
    if (!openTrack.href || openTrack.href.endsWith("#")) e.preventDefault();
  });

  // INIT
  renderList();
  setActive();
  moveNeedle();
  setPower(false);
  load(0,false);
</script>

</body>
</html>

